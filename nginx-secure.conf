worker_processes auto;

events {
    worker_connections 2048;
    use select;  # Windows usa select
}

http {
    server_names_hash_bucket_size 64;
    include C:/nginx/conf/mime.types;
    default_type application/octet-stream;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 30;
    keepalive_requests 100;
    
    # Ocultar versão do Nginx
    server_tokens off;
    
    # Tamanhos de buffer para evitar ataques
    client_body_buffer_size 1M;
    client_max_body_size 10M;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;
    
    # Timeouts de segurança
    client_body_timeout 12;
    client_header_timeout 12;
    send_timeout 10;
    
    # Identificar rede interna (sem rate limiting)
    geo $internal_network {
        default 0;
        192.168.0.0/16 1;
        10.0.0.0/8 1;
        172.16.0.0/12 1;
        127.0.0.1/32 1;
    }
    
    # Rate limiting condicional - libera rede interna
    map $internal_network $limit_key {
        0 $binary_remote_addr;
        1 "";
    }
    
    # Rate Limiting - Zona para limitar requisições por IP (apenas externos)
    limit_req_zone $limit_key zone=api_limit:10m rate=30r/s;
    limit_req_zone $limit_key zone=login_limit:10m rate=5r/m;
    limit_conn_zone $limit_key zone=conn_limit:10m;
    
    # Log de requisições suspeitas
    log_format security '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '"$http_referer" "$http_user_agent" '
                       'req_time=$request_time';
    
    # Bloquear user agents maliciosos
    map $http_user_agent $blocked_agent {
        default 0;
        ~*(bot|crawler|spider|scraper|masscan|nikto|sqlmap|nmap) 1;
    }
    
    # Identificar rede interna (sem rate limiting)
    geo $internal_network {
        default 0;
        192.168.0.0/16 1;
        10.0.0.0/8 1;
        172.16.0.0/12 1;
        127.0.0.1/32 1;
    }

    ########################################################
    # HTTP - Redireciona para HTTPS (Onze Motores)
    ########################################################
    server {
        listen 80;
        server_name api.onzemotores.com.br;
        
        # Rate limiting (automaticamente liberado para rede interna)
        limit_req zone=api_limit burst=50 nodelay;
        limit_conn conn_limit 20;

        # Bloquear user agents maliciosos (APENAS externos)
        if ($blocked_agent) {
            set $block_ua 1;
        }
        if ($internal_network) {
            set $block_ua 0;
        }
        if ($block_ua) {
            return 403;
        }

        location /.well-known/acme-challenge/ {
            root C:/win-acme/wwwroot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    ########################################################
    # N8N - HTTP via IP público (COM PROTEÇÃO)
    ########################################################
    server {
        listen 80;
        server_name 168.228.245.79;
        
        # Rate limiting (automaticamente liberado para rede interna)
        limit_req zone=api_limit burst=20 nodelay;
        limit_conn conn_limit 10;
        
        # Bloquear user agents maliciosos (APENAS externos)
        if ($blocked_agent) {
            set $block_ua 1;
        }
        if ($internal_network) {
            set $block_ua 0;
        }
        if ($block_ua) {
            return 403;
        }

        location / {
            proxy_pass http://127.0.0.1:5678;
            proxy_http_version 1.1;

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_read_timeout 300;
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            
            # Proteção contra buffer overflow
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
        }
    }

    ########################################################
    # HTTPS (Onze Motores API) - COM SEGURANÇA MÁXIMA
    ########################################################
    server {
        listen 443 ssl http2;
        server_name api.onzemotores.com.br;

        # Certificados SSL
        ssl_certificate C:/win-acme/certificates/api.onzemotores.com.br-chain.pem;
        ssl_certificate_key C:/win-acme/certificates/api.onzemotores.com.br-key.pem;

        # Protocolos SSL seguros
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;
        
        # SSL Session Cache
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        
        # OCSP Stapling
        ssl_stapling on;
        ssl_stapling_verify on;
        
        # Headers de segurança
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        
        # Rate limiting (automaticamente liberado para rede interna)
        limit_req zone=api_limit burst=100 nodelay;
        limit_conn conn_limit 50;
        
        # Bloquear user agents maliciosos (APENAS externos)
        if ($blocked_agent) {
            set $block_ua 1;
        }
        if ($internal_network) {
            set $block_ua 0;
        }
        if ($block_ua) {
            return 403;
        }
        
        # Proteção contra métodos HTTP não permitidos (APENAS externos)
        if ($request_method !~ ^(GET|POST|PUT|PATCH|DELETE|OPTIONS|HEAD)$ ) {
            set $bad_method 1;
        }
        if ($internal_network) {
            set $bad_method 0;
        }
        if ($bad_method) {
            return 405;
        }

        # Endpoint de login com rate limit especial (automaticamente liberado para rede interna)
        location ~ ^/api/(auth|login|signin) {
            limit_req zone=login_limit burst=3 nodelay;
            
            proxy_pass http://127.0.0.1:4882;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
        }

        # Todas as outras rotas da API
        location / {
            proxy_pass http://127.0.0.1:4882;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Proteção contra buffer overflow
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    }

    ########################################################
    # Rio Verde Transportes
    ########################################################
    include C:/Projetos/Rio-Verde/nginx-rioverde.conf;
}
